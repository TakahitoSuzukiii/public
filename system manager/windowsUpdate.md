# ğŸªŸ WindowsUpdate è‡ªå‹•åŒ–ã‚¿ã‚¹ã‚¯æ§‹æˆè³‡æ–™  
ï¼ˆè¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ + ã‚¹ãƒ†ãƒƒãƒ—å®Ÿè¡Œ + æˆå¦é€šçŸ¥ï¼‰

---

## ğŸ“Œ ã‚¿ã‚¹ã‚¯æ¦‚è¦

| é …ç›®     | å†…å®¹                                                              |
| -------- | ----------------------------------------------------------------- |
| ã‚¿ã‚¹ã‚¯å | WindowsUpdateè‡ªå‹•åŒ–ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œï¼‰                           |
| å¯¾è±¡     | è¤‡æ•°ã® Windows Server ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹                                |
| å®Ÿè¡Œå†…å®¹ | æ›´æ–°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®é©ç”¨ã¨å†èµ·å‹•ã€AMIå–å¾—ã€ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªãªã©12ã‚¹ãƒ†ãƒƒãƒ— |
| å®Ÿè¡Œæ–¹æ³• | Systems Manager Automationï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« or ä»»æ„å®Ÿè¡Œï¼‰            |
| é€šçŸ¥     | å®Ÿè¡Œå®Œäº†å¾Œã« Microsoft Teams ã¨ãƒ¡ãƒ¼ãƒ«ï¼ˆSNSï¼‰ã«æˆåŠŸ/å¤±æ•—ã‚’é€šçŸ¥     |
| é€šçŸ¥å†…å®¹ | å„ã‚¹ãƒ†ãƒƒãƒ—ã®æˆåŠŸ/å¤±æ•—ã€å¯¾è±¡ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®çŠ¶æ…‹ã‚’å«ã‚€               |

---

## ğŸ¯ ã‚¹ãƒ†ãƒƒãƒ—ä¸€è¦§

| ã‚¹ãƒ†ãƒƒãƒ—ç•ªå· | å‡¦ç†å†…å®¹                                                         |
| ------------ | ---------------------------------------------------------------- |
| 1            | ping ã«ã‚ˆã‚‹ç–é€šç¢ºèªï¼ˆSSMçµŒç”±ï¼‰                                   |
| 2            | EC2ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®åœæ­¢                                            |
| 3            | å„ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã® AMI å–å¾—                                        |
| 4            | AMI ã®ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚µã‚¤ã‚ºãŒ 1%ä»¥ä¸Šã«ãªã‚‹ã¾ã§å¾…æ©Ÿï¼ˆï¼‹3åˆ†å¾…æ©Ÿï¼‰ |
| 5            | ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®èµ·å‹•                                               |
| 6            | Windows Update ã®é©ç”¨ï¼ˆSSM Documentï¼‰                            |
| 7            | æ›´æ–°ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†ç¢ºèªï¼ˆå†èµ·å‹•è¦æ±‚ã®æœ‰ç„¡ãªã©ï¼‰     |
| 8            | 3åˆ†å¾…æ©Ÿ                                                          |
| 9            | ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã®å†èµ·å‹•                                             |
| 10           | 1åˆ†å¾…æ©Ÿ                                                          |
| 11           | ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèªï¼ˆWinRM/SSMã‚»ãƒƒã‚·ãƒ§ãƒ³ç¢ºèªï¼‰                          |
| 12           | æˆå¦ã‚’ã¾ã¨ã‚ã¦é€šçŸ¥ï¼ˆSNS + Teamsï¼‰                                |

---

## ğŸ§© æ§‹æˆå›³ï¼ˆMermaidï¼‰

```mermaid
flowchart TD
    A[Automation å®Ÿè¡Œï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« or æ‰‹å‹•ï¼‰] --> B[å¯¾è±¡ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ï¼ˆCSVå½¢å¼ï¼‰]
    B --> C[ç–é€šç¢ºèªï¼ˆpingï¼‰]
    C --> D[ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åœæ­¢]
    D --> E[AMIä½œæˆ]
    E --> F[ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆã‚µã‚¤ã‚ºç¢ºèª + å¾…æ©Ÿ]
    F --> G[ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹èµ·å‹•]
    G --> H[Windows Update å®Ÿè¡Œ]
    H --> I[æ›´æ–°å®Œäº†ç¢ºèª]
    I --> J[å†èµ·å‹• + å¾…æ©Ÿ]
    J --> K[ãƒ­ã‚°ã‚¤ãƒ³ç¢ºèª]
    K --> L[Lambdaã§é€šçŸ¥ï¼ˆSNS + Teamsï¼‰]
```

---

## ğŸ› ï¸ å®Ÿç¾æ–¹æ³•ï¼ˆæ¦‚è¦ï¼‰

- Automation ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§å„ã‚¹ãƒ†ãƒƒãƒ—ã‚’é †ã«å®šç¾©ï¼ˆaws:runCommand, aws:waitForAwsResourceProperty, aws:createImage ãªã©ï¼‰
- instanceCsv ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å¯¾è±¡ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’æŒ‡å®š
- Lambda é–¢æ•°ã§é€šçŸ¥ã‚’é€ä¿¡ï¼ˆã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã®çµæœã‚’é›†è¨ˆï¼‰

---

## ğŸ“„ Automation ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆæ§‹æˆä¾‹ï¼‰

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯é•·ã„ãŸã‚ã€ä»¥ä¸‹ã®ã‚ˆã†ãªæ§‹æˆã§åˆ†å‰²ã—ã¦è¨˜è¿°ã—ã¾ã™ï¼š

1. parseInstanceIdsï¼ˆCSV â†’ Listï¼‰
2. pingCheckï¼ˆaws:runCommandï¼‰
3. stopInstancesï¼ˆaws:changeInstanceStateï¼‰
4. createAmiï¼ˆaws:createImageï¼‰
5. waitForSnapshotï¼ˆaws:waitForAwsResourceProperty + aws:sleepï¼‰
6. startInstancesï¼ˆaws:changeInstanceStateï¼‰
7. runWindowsUpdateï¼ˆaws:runCommand â†’ AWS-InstallWindowsUpdatesï¼‰
8. checkUpdateStatusï¼ˆaws:runCommandï¼‰
9. sleep3minï¼ˆaws:sleepï¼‰
10. rebootInstancesï¼ˆaws:changeInstanceStateï¼‰
11. sleep1minï¼ˆaws:sleepï¼‰
12. loginCheckï¼ˆaws:runCommand or Sessionç¢ºèªï¼‰
13. notifyCompletionï¼ˆaws:invokeLambdaFunctionï¼‰

å„ã‚¹ãƒ†ãƒƒãƒ—ã«ã¯ Outputs ã‚’å®šç¾©ã—ã€æœ€çµ‚ã‚¹ãƒ†ãƒƒãƒ—ã§é›†ç´„ã—ã¦é€šçŸ¥ã«å«ã‚ã¾ã™ã€‚

---

## ğŸ“¬ é€šçŸ¥å†…å®¹ï¼ˆä¾‹ï¼‰

```
âœ… WindowsUpdate è‡ªå‹•åŒ–ã‚¿ã‚¹ã‚¯å®Œäº†
ğŸ“… å®Ÿè¡Œæ—¥æ™‚: 2025-08-15 03:00 JST
ğŸ–¥ï¸ å¯¾è±¡ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹:
- i-0123abcd: Success
- i-0456efgh: Failed (Step 6: Windows Update)
ğŸ“Š ã‚¹ãƒ†ãƒƒãƒ—çµæœ:
- Step 1 (Ping): Success
- Step 2 (Stop): Success
- Step 3 (AMI): Success
- Step 4 (Snapshot): Success
- Step 5 (Start): Success
- Step 6 (Update): âŒ Failed on i-0456efgh
- Step 7 (Check): Skipped
- Step 8 (Wait): Skipped
- Step 9 (Reboot): Skipped
- Step 10 (Wait): Skipped
- Step 11 (Login): Skipped
```

---

## âœ… ã¾ã¨ã‚

| æ©Ÿèƒ½                           | å¯¾å¿œå†…å®¹                                        |
| ------------------------------ | ----------------------------------------------- |
| ã‚¹ãƒ†ãƒƒãƒ—åˆ¶å¾¡                   | Automation ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§12ã‚¹ãƒ†ãƒƒãƒ—ã‚’é †æ¬¡å®Ÿè¡Œ   |
| è¤‡æ•°ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å¯¾å¿œ           | CSVå½¢å¼ã§æŒ‡å®šã—ã€å…¨ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã«åŒæ™‚é©ç”¨       |
| Windows Update                 | AWS-InstallWindowsUpdates ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½¿ç”¨    |
| AMIå–å¾— + ã‚¹ãƒŠãƒƒãƒ—ã‚·ãƒ§ãƒƒãƒˆç¢ºèª | createImage + waitForAwsResourceProperty ã§å®Ÿç¾ |
| é€šçŸ¥                           | Lambdaé–¢æ•°ã§ SNSï¼ˆãƒ¡ãƒ¼ãƒ«ï¼‰ + Teams ã«é€ä¿¡       |
| å®Ÿè¡Œå½¢å¼                       | ä»»æ„å®Ÿè¡Œ or cronã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§å®šæœŸå®Ÿè¡Œå¯èƒ½      |
